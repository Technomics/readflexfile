devtools::load_all()
test_data <- read_folder("I:/Tools/costverse/data/readflexfile", read_ff)
standard <- read_ff("I:/Tools/costverse/data/readflexfile/1. standard_category_id.zip")
detailed <- read_ff("I:/Tools/costverse/data/readflexfile/2. detailed_category_id.zip")
df <- test_data %>%
listindex_to_col(var = "doc_id") %>%
stack_ff()
flexfile <- df
df <- df %>%
flatten_ff()
colnames(df$actualcosthourdata)
# reference workbook with template
sheetnames <- excel_sheets("C:/2. cade-offsite/Army Depots/Submissions/PIM_S_ALR_Anniston/11-01-2018-data/mapped data/Documentation.xlsx")
library(knitr)
library(knitr)
library(kableExtra)
library(kableExtra)
library(readxl)
library(readxl)
library(dplyr)
library(tidyr)
# reference workbook with template
sheetnames <- excel_sheets("C:/2. cade-offsite/Army Depots/Submissions/PIM_S_ALR_Anniston/11-01-2018-data/mapped data/Documentation.xlsx")
i = 1
for (i in 1:length(sheetnames)){
# reference workbook with template
tempdf <- read_excel(path = "C:/2. cade-offsite/Army Depots/Submissions/PIM_S_ALR_Anniston/11-01-2018-data/mapped data/Documentation.xlsx", sheet = sheetnames[i])
tempdf$sheetname <- sheetnames[i]
assign(sheetnames[[i]], tempdf)
}
devtools::load_all()
test_data <- read_folder("I:/Tools/costverse/data/readflexfile", read_ff)
standard <- read_ff("I:/Tools/costverse/data/readflexfile/1. standard_category_id.zip")
detailed <- read_ff("I:/Tools/costverse/data/readflexfile/2. detailed_category_id.zip")
test_data <- read_folder("I:/Tools/costverse/data/readflexfile", read_ff)
standard <- read_ff("I:/Tools/costverse/data/readflexfile/1. standard_category_id.zip")
test_data <- read_folder("I:/Tools/costverse/data/readflexfile", read_ff)
standard <- read_ff("I:/Tools/costverse/data/readflexfile/1. standard_category_id.zip")
detailed <- read_ff("I:/Tools/costverse/data/readflexfile/2. detailed_category_id.zip")
df <- test_data %>%
listindex_to_col(var = "doc_id") %>%
stack_ff()
flexfile <- df
df <- df %>%
flatten_ff()
View(df)
# selects all, but provides a quick safety net in case of changes
cats <- readflexfile::sfc_mapping %>%
dplyr::distinct(standard_category_id, detailed_standard_category_id, direct_or_overhead)
dir_oh <- readflexfile::sfc_mapping %>%
dplyr::distinct(standard_category_id, direct_or_overhead)
join_sfc <- function(the_table) {
the_table %>%
dplyr::left_join(cats, by = "detailed_standard_category_id", suffix = c("", "_sfc")) %>%
dplyr::mutate(standard_category_id = dplyr::coalesce(standard_category_id,
standard_category_id_sfc)) %>%
dplyr::select(-direct_or_overhead, -standard_category_id_sfc) %>%
dplyr::left_join(dir_oh, by = "standard_category_id")
}
join_sfc_tables <- c("actualcosthourdata", "forecastatcompletioncosthourdata")
flexfile_sfc <- purrr::modify_at(flexfile, join_sfc_tables, join_sfc)
actuals <- flatten_actuals(flexfile_sfc, .id)
actuals <- flatten_actuals(flexfile_sfc, _sfc)
flexfile_sfc$accounts
actuals <- flatten_actuals(flexfile_sfc, _id)
actuals <- flatten_actuals(flexfile_sfc, .id)
?setNames
flexfile$actualcosthourdata %>%
dplyr::left_join(dplyr::select(flexfile$reportmetadata,
c(program_name,
reporting_organization_organization_name,
1)),
by = .id) %>%
dplyr::left_join(dplyr::select(flexfile$accounts,
c(id, name, 1)),
by = setNames(c("id", .id), c("account_id", .id)),
suffix = c("", ".accounts")) %>%
dplyr::left_join(dplyr::select(flexfile$enditems,
c(id, name, 1)),
by = setNames(c("id", .id), c("end_item_id", .id)),
suffix = c("", ".enditems")) %>%
dplyr::left_join(dplyr::select(flexfile$ordersorlots,
c(id, name, 1)),
by = setNames(c("id", .id), c("order_or_lot_id", .id)),
suffix = c("", ".ordersorlots")) %>%
dplyr::left_join(dplyr::select(flexfile$clins,
c(id, name, 1)),
by = setNames(c("id", .id), c("clin_id", .id)),
suffix = c("", ".clins")) %>%
dplyr::left_join(dplyr::select(flexfile$wbs,
c(level, id, name, parent_id, 1)),
by = setNames(c("id", .id), c("wbs_element_id", .id)),
suffix = c("", ".wbs")) %>%
dplyr::left_join(dplyr::select(flexfile$functionalcategories,
c(id, name, 1)),
by = setNames(c("id", .id), c("functional_category_id", .id)),
suffix = c("", ".functionalcategories")) %>%
dplyr::left_join(dplyr::select(flexfile$functionaloverheadcategories,
c(id, name, 1)),
by = setNames(c("id", .id), c("functional_overhead_category_id", .id)),
suffix = c("", ".overheadcategories")) %>%
dplyr::left_join(dplyr::select(flexfile$reportingcalendar,
c(id, start_date, end_date, 1)),
by = setNames(c("id", .id), c("reporting_period_id", .id)),
suffix = c("", ".reportingcalendar")) %>%
dplyr::mutate(start_date = lubridate::ymd(start_date),
end_date = lubridate::ymd(end_date),
atd_or_fac = "ATD") %>%
dplyr::rename(account_name = name,
clin_name = name.clins,
wbs_parent = parent_id,
wbs_name = name.wbs,
end_item_name = name.enditems,
order_or_lot_name = name.ordersorlots,
wbs_level = level,
functional_category_name = name.functionalcategories,
functional_overhead_category_name = name.overheadcategories) %>%
dplyr::select(-account_id,
-clin_id,
-functional_category_id,
-functional_overhead_category_id,
-reporting_period_id,
-end_item_id,
-order_or_lot_id,
-account_id,
-order_or_lot_id)
flexfile_sfc <- purrr::modify_at(flexfile, join_sfc_tables, join_sfc)
flexfile_sfc$actualcosthourdata
flexfile_sfc$actualcosthourdata %>% distinct(standard_category)
flexfile_sfc$actualcosthourdata %>% dplyr::distinct(standard_category)
flexfile_sfc$actualcosthourdata %>% dplyr::select(standard_categry) %>% dplyr::distinct(standard_category)
flexfile_sfc$actualcosthourdata %>% dplyr::select(standard_category) %>% dplyr::distinct(standard_category)
flexfile_sfc$actualcosthourdata %>% dplyr::select(standard_category)
flexfile_sfc$actualcosthourdata$standard_category_id
unique(flexfile_sfc$actualcosthourdata$standard_category_id)
actuals <- flatten_actuals(flexfile_sfc, .id)
flatten_actuals <- function(flexfile, .id)  {
flexfile$actualcosthourdata %>%
# dplyr::left_join(dplyr::select(flexfile$reportmetadata,
#                                c(program_name,
#                                  reporting_organization_organization_name,
#                                  1)),
#                  by = .id) %>%
dplyr::left_join(dplyr::select(flexfile$accounts,
c(id, name, 1)),
by = setNames(c("id", .id), c("account_id", .id)),
suffix = c("", ".accounts")) %>%
dplyr::left_join(dplyr::select(flexfile$enditems,
c(id, name, 1)),
by = setNames(c("id", .id), c("end_item_id", .id)),
suffix = c("", ".enditems")) %>%
dplyr::left_join(dplyr::select(flexfile$ordersorlots,
c(id, name, 1)),
by = setNames(c("id", .id), c("order_or_lot_id", .id)),
suffix = c("", ".ordersorlots")) %>%
dplyr::left_join(dplyr::select(flexfile$clins,
c(id, name, 1)),
by = setNames(c("id", .id), c("clin_id", .id)),
suffix = c("", ".clins")) %>%
dplyr::left_join(dplyr::select(flexfile$wbs,
c(level, id, name, parent_id, 1)),
by = setNames(c("id", .id), c("wbs_element_id", .id)),
suffix = c("", ".wbs")) %>%
dplyr::left_join(dplyr::select(flexfile$functionalcategories,
c(id, name, 1)),
by = setNames(c("id", .id), c("functional_category_id", .id)),
suffix = c("", ".functionalcategories")) %>%
dplyr::left_join(dplyr::select(flexfile$functionaloverheadcategories,
c(id, name, 1)),
by = setNames(c("id", .id), c("functional_overhead_category_id", .id)),
suffix = c("", ".overheadcategories")) %>%
dplyr::left_join(dplyr::select(flexfile$reportingcalendar,
c(id, start_date, end_date, 1)),
by = setNames(c("id", .id), c("reporting_period_id", .id)),
suffix = c("", ".reportingcalendar")) %>%
dplyr::mutate(start_date = lubridate::ymd(start_date),
end_date = lubridate::ymd(end_date),
atd_or_fac = "ATD") %>%
dplyr::rename(account_name = name,
clin_name = name.clins,
wbs_parent = parent_id,
wbs_name = name.wbs,
end_item_name = name.enditems,
order_or_lot_name = name.ordersorlots,
wbs_level = level,
functional_category_name = name.functionalcategories,
functional_overhead_category_name = name.overheadcategories) %>%
dplyr::select(-account_id,
-clin_id,
-functional_category_id,
-functional_overhead_category_id,
-reporting_period_id,
-end_item_id,
-order_or_lot_id,
-account_id,
-order_or_lot_id)
}
flexfile_sfc$actualcosthourdata %>% dplyr::select(standard_category)
actuals <- flatten_actuals(flexfile_sfc, .id)
devtools::load_all()
flexfile <- df
df <- df %>%
flatten_ff()
join_sfc <- function(the_table) {
the_table %>%
dplyr::left_join(cats, by = "detailed_standard_category_id", suffix = c("", "_sfc")) %>%
dplyr::mutate(standard_category_id = dplyr::coalesce(standard_category_id,
standard_category_id_sfc)) %>%
dplyr::select(-direct_or_overhead, -standard_category_id_sfc) %>%
dplyr::left_join(dir_oh, by = "standard_category_id")
}
join_sfc_tables <- c("actualcosthourdata", "forecastatcompletioncosthourdata")
flexfile_sfc <- purrr::modify_at(flexfile, join_sfc_tables, join_sfc)
actuals <- flatten_actuals(flexfile_sfc, .id)
cats <- readflexfile::sfc_mapping %>%
dplyr::distinct(standard_category_id, detailed_standard_category_id, direct_or_overhead)
dir_oh <- readflexfile::sfc_mapping %>%
dplyr::distinct(standard_category_id, direct_or_overhead)
join_sfc <- function(the_table) {
the_table %>%
dplyr::left_join(cats, by = "detailed_standard_category_id", suffix = c("", "_sfc")) %>%
dplyr::mutate(standard_category_id = dplyr::coalesce(standard_category_id,
standard_category_id_sfc)) %>%
dplyr::select(-direct_or_overhead, -standard_category_id_sfc) %>%
dplyr::left_join(dir_oh, by = "standard_category_id")
}
join_sfc_tables <- c("actualcosthourdata", "forecastatcompletioncosthourdata")
# for the tables where relevant, join in the sfc mappings
flexfile_sfc <- purrr::modify_at(flexfile, join_sfc_tables, join_sfc)
actuals <- flatten_actuals(flexfile_sfc, .id)
actuals <- flatten_actuals(flexfile_sfc, .id = "doc_id")
forecasts <- flatten_forecasts(flexfile_sfc, .id = "doc_id")
dplyr::bind_rows(actuals, forecasts) %>%
flexfile_order_columns()
x <- dplyr::bind_rows(actuals, forecasts
x <- dplyr::bind_rows(actuals, forecasts)
x <- dplyr::bind_rows(actuals, forecasts)
colnames(x)
devtools::load_all()
test_data <- read_folder("I:/Tools/costverse/data/readflexfile", read_ff)
df <- test_data %>%
listindex_to_col(var = "doc_id") %>%
stack_ff()
df <- df %>%
flatten_ff()
df %>% dplyr::distinct(standard_category_id, detailed_standard_category_id)
x <- df %>% dplyr::distinct(standard_category_id, detailed_standard_category_id)
View(x)
standard_df <- standard %>%
add_id_col(var = "doc_id") %>%
flatten_ff()
standard_df %>% dplyr::distinct(standard_category_id, detailed_standard_category_id)
detailed_df <- detailed %>%
add_id_col(var = "doc_id") %>%
flatten_ff()
detailed_df %>% dplyr::distinct(standard_category_id, detailed_standard_category_id)
test_data <- read_folder("I:/Tools/costverse/data/readflexfile", read_ff)
devtools::load_all()
standard <- read_ff("I:/Tools/costverse/data/readflexfile/1. standard_category_id.zip")
detailed <- read_ff("I:/Tools/costverse/data/readflexfile/2. detailed_category_id.zip")
test_df <- test_data %>%
listindex_to_col(var = "doc_id") %>%
stack_ff() %>%
flatten_ff()
df %>% dplyr::distinct(standard_category_id, detailed_standard_category_id)
test_df %>% dplyr::distinct(standard_category_id, detailed_standard_category_id)
standard_df <- standard %>%
add_id_col(var = "doc_id") %>%
flatten_ff()
standard_df %>% dplyr::distinct(standard_category_id, detailed_standard_category_id)
detailed_df <- detailed %>%
add_id_col(var = "doc_id") %>%
flatten_ff()
detailed_df %>% dplyr::distinct(standard_category_id, detailed_standard_category_id)
usethis::use_version()
devtools::check()
devtools::check()
devtools::check()
devtools::check()
usethis::use_version()
devtools::build(binary = TRUE)
devtools::build()
